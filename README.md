# Scoliologic Wiki

<div align="center">

![Scoliologic Wiki](docs/screenshots/09_home.webp)

**Корпоративная база знаний с искусственным интеллектом**

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Docker](https://img.shields.io/badge/docker-ready-brightgreen.svg)](docker-compose.yml)
[![TypeScript](https://img.shields.io/badge/TypeScript-5.0-blue.svg)](https://www.typescriptlang.org/)
[![React](https://img.shields.io/badge/React-19-61dafb.svg)](https://reactjs.org/)

</div>

---

## Обзор

Scoliologic Wiki — это современная корпоративная wiki-платформа, разработанная для группы компаний Scoliologic. Система объединяет удобный Notion-подобный редактор с мощными AI-возможностями для поиска и создания контента. Все AI-функции работают локально через Ollama, что гарантирует полную конфиденциальность данных.

### Ключевые преимущества

| Преимущество | Описание |
|-------------|----------|
| **Notion-подобный редактор** | WYSIWYG редактор с автоформатированием, поддержкой таблиц, кода и медиа |
| **Локальный AI** | Семантический поиск и 9 инструментов для написания через Ollama |
| **Полный контроль доступа** | Роли, группы, уровни доступа к страницам |
| **Self-hosted** | Docker Compose развёртывание за 5 минут |
| **Интеграция Authentik** | OAuth2 авторизация и синхронизация групп |

---

## Функциональность

### Редактор контента

![Редактор](docs/screenshots/02_editor.webp)

Полнофункциональный WYSIWYG редактор на базе TipTap предоставляет все необходимые инструменты для создания документации:

- **Форматирование текста**: жирный, курсив, подчёркивание, зачёркивание
- **Структура**: заголовки H1-H6, маркированные и нумерованные списки, чек-листы
- **Код**: блоки кода с подсветкой синтаксиса, inline-код
- **Медиа**: изображения через S3, видео (YouTube, RuTube, VK Video)
- **Таблицы**: создание и редактирование таблиц с управлением ячейками
- **Цитаты и ссылки**: блоки цитат, внешние и внутренние ссылки

Редактор поддерживает автоформатирование при вводе — Markdown-синтаксис автоматически преобразуется в соответствующие элементы:

| Ввод | Результат |
|------|-----------|
| `# ` | Заголовок H1 |
| `## ` | Заголовок H2 |
| `- ` или `* ` | Маркированный список |
| `1. ` | Нумерованный список |
| `[] ` | Чек-лист |
| ` ``` ` | Блок кода |
| `> ` | Цитата |

---

### Иерархическая структура страниц

![Структура страниц](docs/screenshots/01_wiki_main.webp)

Система организации контента позволяет создавать логичную древовидную структуру документации:

- **Неограниченная вложенность** — страницы могут содержать подстраницы любой глубины
- **Древовидная навигация** — боковая панель с раскрывающимися разделами
- **Drag-and-drop** — перетаскивание страниц для реорганизации структуры
- **Быстрый поиск** — мгновенный поиск по дереву страниц
- **Иконки** — эмодзи и иконки для визуального различения страниц

---

### Интеллектуальный поиск

![Поиск](docs/screenshots/04_search.webp)

Система предоставляет два режима поиска для максимальной эффективности:

**Текстовый поиск** обеспечивает точное совпадение по ключевым словам с мгновенными результатами, подсветкой найденных фрагментов и фильтрами по дате, автору и статусу.

**AI-поиск (семантический)** использует векторные embeddings через локальный Ollama для понимания смысла запроса. Система находит релевантный контент даже без точных совпадений слов. Например, запрос «как настроить доступ» найдёт статьи о правах пользователей, управлении группами и ролях.

---

### AI-помощник для написания

![AI-помощник](docs/screenshots/03_ai_menu.webp)

Встроенный AI-помощник предоставляет 9 инструментов для создания и улучшения контента:

| Инструмент | Описание |
|-----------|----------|
| **Improve Writing** | Улучшение стиля и читаемости текста |
| **Expand Text** | Расширение кратких заметок в полные статьи |
| **Summarize** | Создание кратких резюме из длинных текстов |
| **Fix Grammar** | Исправление грамматики и орфографии |
| **Change Tone** | Изменение тона (формальный, неформальный, технический) |
| **Extract Keywords** | Извлечение ключевых слов для тегов |
| **SEO Optimize** | Оптимизация контента для поиска |
| **Create Outline** | Генерация структуры статьи из темы |
| **Generate Content** | Создание полного контента из плана |

> **Важно**: Все AI-функции работают локально через Ollama — данные не покидают ваш сервер!

---

### Управление доступом

![Управление пользователями](docs/screenshots/06_users.webp)

Гибкая система прав и ролей обеспечивает безопасность корпоративных данных:

**Роли пользователей:**
- **Admin** — полный доступ к системе и настройкам
- **Editor** — создание и редактирование страниц
- **Reader** — только чтение страниц
- **Guest** — доступ к публичным страницам без авторизации

**Уровни доступа к страницам:**
- **Public** — видна всем, включая гостей
- **Group** — видна только членам указанной группы
- **Private** — видна только владельцу страницы

---

### Управление группами

![Управление группами](docs/screenshots/07_groups.webp)

Система групп позволяет организовать пользователей по командам и отделам:

- Создание групп для отделов и команд
- Добавление пользователей в группы
- Назначение прав доступа на уровне группы
- Синхронизация с Authentik

**Примеры использования:**
- Группа «Разработка» — доступ к техническим документам
- Группа «HR» — доступ к кадровым документам
- Группа «Руководство» — доступ ко всем материалам

---

### Аналитика и метрики

![Аналитика](docs/screenshots/08_analytics.webp)

Дашборд аналитики предоставляет полную картину использования wiki:

- **Метрики дашборда**: просмотры страниц, редактирования, поисковые запросы, активные пользователи
- **Популярные страницы**: рейтинг по просмотрам, уникальные посетители, время на странице
- **Аналитика поиска**: топ запросов, количество результатов, выявление пробелов в контенте

---

### Админ-панель

![Админ-панель](docs/screenshots/05_admin_dashboard.webp)

Централизованная панель управления для администраторов системы:

- Управление пользователями и их ролями
- Управление группами и членством
- Мониторинг системы и активности
- Настройки интеграций (Authentik, Ollama)
- Журнал аудита действий

---

### Дополнительные возможности

**Версионирование** — полная история изменений каждой страницы с возможностью просмотра любой версии, отката и сравнения версий.

**Шаблоны страниц** — готовые шаблоны для типовых документов, создание собственных шаблонов, быстрое создание страниц из шаблона.

**Экспорт** — выгрузка страниц в PDF для печати и архивации, Markdown для миграции.

**Тёмная тема** — автоопределение по системным настройкам, ручное переключение, комфортная работа в любое время.

![Тёмная тема](docs/screenshots/10_dark_theme.webp)

---

## Технологический стек

| Компонент | Технология |
|-----------|-----------|
| **Frontend** | React 19, TypeScript, TailwindCSS, TipTap |
| **Backend** | Node.js, Express, tRPC |
| **База данных** | PostgreSQL |
| **Хранилище** | MinIO (S3-совместимое) |
| **AI** | Ollama (локальные модели) |
| **Авторизация** | Authentik OAuth2 |
| **Reverse Proxy** | Traefik с автоматическим SSL |

---

## Быстрый старт

### Требования

- Docker и Docker Compose
- 8GB+ RAM (16GB+ рекомендуется для AI)
- 20GB+ дискового пространства
- Authentik сервер для OAuth (опционально)

### Автоматическая установка (Debian/Ubuntu)

```bash
curl -fsSL https://raw.githubusercontent.com/sileade/scoliologic-wiki/main/deploy/install.sh | sudo bash
```

Скрипт предложит выбор:
1. **Full Stack** — новый Traefik + Wiki + Ollama
2. **Wiki Only** — использовать существующий Traefik
3. **Wiki + Ollama** — использовать существующий Traefik с AI

### Ручная установка

1. **Клонируйте репозиторий:**
```bash
git clone https://github.com/sileade/scoliologic-wiki.git
cd scoliologic-wiki
```

2. **Настройте переменные окружения:**
```bash
cp config.env.example config.env
# Отредактируйте config.env с вашими настройками
```

3. **Запустите сервисы:**
```bash
docker-compose up -d
```

4. **Загрузите AI модели:**
```bash
docker exec -it ollama ollama pull nomic-embed-text
docker exec -it ollama ollama pull llama3.2
```

5. **Откройте в браузере:**
```
https://wiki.yourdomain.com
```

---

## Конфигурация

### Переменные окружения

| Переменная | Описание | Пример |
|-----------|----------|--------|
| `WIKI_DOMAIN` | Домен для wiki | `wiki.example.com` |
| `DATABASE_URL` | Строка подключения к PostgreSQL | `postgresql://user:pass@db:5432/wiki` |
| `S3_ENDPOINT` | Endpoint MinIO/S3 | `http://minio:9000` |
| `S3_ACCESS_KEY` | Ключ доступа S3 | `minioadmin` |
| `S3_SECRET_KEY` | Секретный ключ S3 | `minioadmin` |
| `OLLAMA_URL` | URL Ollama сервера | `http://ollama:11434` |
| `AUTHENTIK_URL` | URL Authentik сервера | `https://auth.example.com` |
| `AUTHENTIK_CLIENT_ID` | Client ID OAuth | `wiki-client` |
| `AUTHENTIK_CLIENT_SECRET` | Client Secret OAuth | `secret` |

### Интеграция с Authentik

Для настройки OAuth2 авторизации через Authentik:

1. Создайте OAuth2/OpenID Provider в Authentik
2. Настройте Redirect URI: `https://wiki.yourdomain.com/api/oauth/callback`
3. Добавьте Client ID и Secret в `config.env`
4. Включите синхронизацию групп в настройках админ-панели

### AI-модели (Ollama)

После запуска загрузите необходимые модели:

```bash
# Модель для эмбеддингов (семантический поиск)
docker exec wiki-ollama ollama pull nomic-embed-text

# Модель для генерации текста (AI-помощник)
docker exec wiki-ollama ollama pull llama3.2
```

---

## Структура проекта

```
scoliologic-wiki/
├── client/                 # Frontend (React)
│   ├── src/
│   │   ├── components/     # UI компоненты
│   │   ├── pages/          # Страницы приложения
│   │   ├── hooks/          # React хуки
│   │   └── lib/            # Утилиты и tRPC клиент
│   └── public/             # Статические файлы
├── server/                 # Backend (Node.js)
│   ├── routers.ts          # tRPC роутеры
│   ├── db.ts               # Функции работы с БД
│   └── _core/              # Ядро сервера
├── drizzle/                # Схема базы данных
├── storage/                # S3 хелперы
├── shared/                 # Общие типы и константы
├── deploy/                 # Docker конфигурация
│   ├── docker-compose.yml      # Базовая конфигурация
│   ├── docker-compose.full.yml # Полный стек с Traefik
│   ├── Dockerfile              # Сборка приложения
│   └── install.sh              # Скрипт установки
├── docs/                   # Документация
│   └── screenshots/        # Скриншоты
└── config.env.example      # Пример конфигурации
```

---

## API

Wiki использует tRPC для типобезопасного API. Основные эндпоинты:

### Страницы
- `pages.list` — список доступных страниц
- `pages.getById` — получение страницы по ID
- `pages.create` — создание страницы
- `pages.update` — обновление страницы
- `pages.delete` — удаление страницы
- `pages.getVersions` — история версий страницы

### Группы
- `groups.list` — список групп
- `groups.create` — создание группы
- `groups.addMember` — добавление участника
- `groups.removeMember` — удаление участника

### AI
- `ai.search` — семантический поиск
- `ai.assist` — AI-помощник для текста
- `ai.generateEmbedding` — создание эмбеддинга

### Аналитика
- `analytics.getPageViews` — просмотры страниц
- `analytics.getPopularPages` — популярные страницы
- `analytics.getSearchQueries` — поисковые запросы

---

## Резервное копирование

Для автоматического бэкапа базы данных добавьте профиль backup:

```bash
docker compose -f docker-compose.full.yml --profile backup up -d
```

Бэкапы сохраняются в volume `backup-data` с ротацией:
- Ежедневные: 7 дней
- Еженедельные: 4 недели
- Ежемесячные: 6 месяцев

---

## Обновление

```bash
cd /opt/scoliologic-wiki
git pull
docker compose -f docker-compose.full.yml build
docker compose -f docker-compose.full.yml up -d
```

---

## Разработка

### Локальный запуск

```bash
# Установка зависимостей
pnpm install

# Запуск в режиме разработки
pnpm dev

# Запуск unit тестов
pnpm test

# Запуск E2E тестов
pnpm test:e2e

# E2E тесты с UI
pnpm test:e2e:ui

# Сборка для продакшена
pnpm build
```

### База данных

```bash
# Применение миграций
pnpm db:push

# Генерация миграций
pnpm db:generate
```

---

## Production Features

### Redis Caching

Система поддерживает Redis для кэширования сессий и прав доступа:

```bash
# Добавьте в config.env
REDIS_URL=redis://redis:6379
```

**Кэшируемые данные:**
- Сессии пользователей (TTL: 24 часа)
- Права доступа к страницам (TTL: 5 минут)
- Результаты поиска (TTL: 10 минут)

**Преимущества:**
- Ускорение повторных запросов на 80-90%
- Снижение нагрузки на базу данных
- Graceful degradation при недоступности Redis

### Sentry Monitoring

Интеграция с Sentry для отслеживания ошибок в production:

```bash
# Добавьте в config.env
SENTRY_DSN=https://xxx@sentry.io/xxx
```

**Функции:**
- Автоматический захват исключений
- Performance monitoring
- Фильтрация чувствительных данных
- Breadcrumbs для отладки

### Rate Limiting

Защита API от злоупотреблений:

| Endpoint | Лимит | Окно |
|----------|-------|------|
| Общий API | 100 запросов | 15 мин |
| Авторизация | 10 запросов | 15 мин |
| AI функции | 20 запросов | 1 мин |
| Поиск | 30 запросов | 1 мин |
| Загрузка файлов | 50 запросов | 15 мин |
| Админ API | 200 запросов | 15 мин |

### E2E Testing

Проект включает E2E тесты на Playwright:

```bash
# Установка браузеров
npx playwright install chromium

# Запуск тестов
pnpm test:e2e

# Запуск с UI
pnpm test:e2e:ui
```

**Покрытие тестами:**
- Главная страница и навигация
- Wiki редактор и структура страниц
- Поиск (текстовый и AI)
- Админ-панель
- Переключение темы
- Responsive design
- Accessibility

---

## Лицензия

MIT License. См. файл [LICENSE](LICENSE) для деталей.

---

## Поддержка

При возникновении вопросов или проблем:
- Создайте Issue в репозитории
- Документация: https://wiki.scoliologic.ru/docs
- Email: support@scoliologic.ru

---

<div align="center">

**Scoliologic Wiki** — Создано для группы компаний Scoliologic

</div>


### CI/CD с GitHub Actions

Проект включает автоматизированный CI/CD pipeline:

```yaml
# .github/workflows/ci.yml
# Автоматически запускается при push и pull request
```

**Этапы pipeline:**
1. **Lint** — проверка кода ESLint
2. **Type Check** — проверка TypeScript
3. **Unit Tests** — запуск Vitest тестов
4. **Build** — сборка production bundle

**Преимущества:**
- Автоматическая проверка качества кода
- Раннее обнаружение ошибок
- Защита main ветки от некорректного кода

---

### WebSocket Real-time Updates

Система поддерживает real-time уведомления через WebSocket:

```typescript
// Использование в компонентах
import { useWebSocket } from '@/hooks/useWebSocket';

const { isConnected, pageUpdates, userPresence } = useWebSocket();
```

**События:**
| Событие | Описание |
|---------|----------|
| `page:updated` | Страница обновлена другим пользователем |
| `page:created` | Создана новая страница |
| `page:deleted` | Страница удалена |
| `user:joined` | Пользователь просматривает страницу |
| `user:left` | Пользователь покинул страницу |

**Функции:**
- Индикатор присутствия пользователей на странице
- Уведомления об изменениях в реальном времени
- Автоматическое переподключение при обрыве связи

---

### PDF Export

Экспорт wiki страниц в PDF для печати и архивации:

```typescript
// API endpoints
trpc.pdf.exportPage({ pageId: 1 })           // Одна страница
trpc.pdf.exportPages({ pageIds: [1, 2, 3] }) // Несколько страниц
trpc.pdf.exportWithChildren({ pageId: 1 })   // Страница с подстраницами
```

**Возможности:**
- Экспорт одной страницы или группы страниц
- Рекурсивный экспорт с подстраницами (до 10 уровней)
- Форматы: A4, Letter, Legal
- Ориентация: портретная или альбомная
- Сохранение форматирования и стилей
- Автоматическая загрузка в S3

**Опции:**
```typescript
{
  format: 'A4' | 'Letter' | 'Legal',
  landscape: boolean
}
```

---

